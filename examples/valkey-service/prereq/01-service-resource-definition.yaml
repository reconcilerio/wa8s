---
apiVersion: services.wa8s.reconciler.io/v1alpha1
kind: ServiceResourceDefinition
metadata:
  name: valkey
spec:
  group: x.services.wa8s.reconciler.io
  instanceNames:
    plural: valkeys
    kind: Valkey
  clientNames:
    plural: valkeyclients
    kind: ValkeyClient
  lifecycle:
    ref:
      kind: Composition
      name: valkey-lifecycle
      namespace: wa8s-service-valkey
    serviceAccountRef:
      name: default
      namespace: wa8s-service-valkey
    hostCapabilities:
      env:
        vars:
        - name: RUST_BACKTRACE
          value: "1"
      network:
        inherit: true
        ipNameLookup: true
    clientRef:
      name: valkey-client
      namespace: wa8s-service-valkey

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    wa8s.reconciler.io/manager: "true"
    app.kubernetes.io/name: wa8s
    app.kubernetes.io/managed-by: kustomize
  name: wa8s-services-x-valkey
rules:
- apiGroups:
  - x.services.wa8s.reconciler.io
  resources:
  - valkeys
  - valkeyclients
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - x.services.wa8s.reconciler.io
  resources:
  - valkeys/status
  - valkeyclients/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - x.services.wa8s.reconciler.io
  resources:
  - valkeys/finalizers
  - valkeyclients/finalizers
  verbs:
  - update

---
apiVersion: wa8s.reconciler.io/v1alpha1
kind: Composition
metadata:
  namespace: wa8s-service-valkey
  name: valkey-lifecycle
spec:
  dependencies:
  - component: componentized:lifecycle
    oci:
      image: ghcr.io/componentized/services/valkey-lifecycle:v0.0.4@sha256:00d667788f5cc5f70441ac709363fc0b06e648e9eb5d63f0e6f632e1c58ff25f
  - component: componentized:config
    config:
      valuesFrom:
      - name: valkey

---
apiVersion: wa8s.reconciler.io/v1alpha1
kind: Component
metadata:
  namespace: wa8s-service-valkey
  name: valkey-client
spec:
  oci:
    image: ghcr.io/componentized/valkey/valkey-client:v0.2.1@sha256:c9672e1ce38df6635787cd9a832cf3b0392b0a5dc9c71016872b22fdf179d331
